<div class="main">
  <div class="flex-container">
    <gn-cmr-mask *ngIf="waitControl" text="Contrôles en cours..."></gn-cmr-mask>
    <div class="cadre" [style.min-height]="cardContentHeight + 'px'" [style.max-height]="cardContentHeight + 'px'">
      <pnx-map height="100%" class="map-card">
        <pnx-gps (markerChanged)="setNewGeometry($event)"></pnx-gps>
        <pnx-leaflet-filelayer (onGeomChange)="onGeomChangeGPSFile($event)" [editMode]="true"></pnx-leaflet-filelayer>
        <pnx-leaflet-draw 
          [geojson]="geometry" 
          [options]="leafletDrawOptions" 
          [zoomLevel]="14"
          (layerDrawed)="setNewGeometry($event)">
        </pnx-leaflet-draw>
        <pnx-geojson
          *ngIf="mapFeatures && mapFeatures['features']"
          [geojson]="mapFeatures"
          [zoomOnLayer]="true"
          [zoomOnFirstTime]="true"
        ></pnx-geojson>
      </pnx-map>
    </div>
    <div id="details-left" class="cadre scroll" [style.max-height]="cardContentHeight + 'px'">
      <gn-cmr-breadcrumb [path]="path" [currentPage]="'Création ' + module.forms.visit.label + ' pour un individu'"></gn-cmr-breadcrumb>
      <h3>Module: {{ module.module_label }}</h3>
      <h4>Création {{module.forms.site.label}}</h4>
      <div class="dynamic-form-wrapper mt-2 mb-2" *ngIf="module.config.use_sitegroup">
        <small>{{module.forms.sitegroup.label}}</small>
        <div class="input-group" *ngIf="module.config.use_sitegroup">
          <select class="form-control" id="sitegroup-to-select" [(ngModel)]="selectedSitegroup" (change)="onSelectSitegroup($event)">
            <option [value]="null"> - </option>
            <option *ngFor="let sg of sitegroups" [value]="sg.id_sitegroup">{{sg.name}}</option>
          </select>
        </div>
      </div>
      <div class="">
        <div class="alert alert-danger" role="alert" *ngIf="!siteForm.value.geom">
          <i class="fa fa-warning"></i>&nbsp;Veuillez saisir une géométrie sur la carte
        </div>
        <pnx-dynamic-form-generator
          class="obj-form"
          #dynamicForm
          [autoGenerated]="true"
          [myFormGroup]="siteForm"
          [formsDefinition]="siteFormDefinitions"
        ></pnx-dynamic-form-generator>
        <gn-cmr-form-error [form]="siteForm"></gn-cmr-form-error>
      </div>
      <hr>
      <h4>Création {{module.forms.visit.label}}</h4>
      <form [formGroup]="visitForm">
        <div class="dynamic-form-wrapper mt-2 mb-2">
          <div class="custom-control custom-checkbox">
            <!-- Force observation at true because always a observation if individual is visited -->
            <input type="checkbox" id="input_observ" class="custom-control-input" checked disabled [formControl]="visitForm.get('observation')">
            <label class="custom-control-label" for="input_observ"><span>Observation(s) pendant la visite?</span></label>
          </div>
        </div>
        <pnx-dynamic-form-generator
          class="obj-form"
          #dynamicForm
          [autoGenerated]="true"
          [myFormGroup]="genericVisitForm"
          [formsDefinition]="visitFormDefinitions"
        ></pnx-dynamic-form-generator>
        <gn-cmr-form-error [form]="genericVisitForm"></gn-cmr-form-error>
        <div class="clearfix mt-3">
          <button class="btn btn-primary float-left" [routerLink]="['..']">Annuler</button>
          <button *ngIf="!bChainInput  && !bEdit" class="btn btn-success float-right ml-2" [disabled]="!siteForm.valid || !visitForm.valid || !genericVisitForm.valid || !visitForm.get('observation').value || bSaving" (click)="onSubmit(true)">
            <i class="fa fa-check" *ngIf="!bSaving"></i>
            <i class="fa fa-spinner fa-spin" *ngIf="bSaving"></i>&nbsp;Valider et ajouter {{module.forms.observation.label}}</button>
        </div>
      </form>
    </div> 
  </div>
</div>
