<div class="main">
  <gn-cmr-mask *ngIf="waitControl" text="Contrôles en cours..."></gn-cmr-mask>
  <gn-cmr-header [path]="path" [currentPage]="(bEdit ? 'Edition ' : 'Création ')+ module.forms.site.label + (bEdit ? ': ' + site.name : '')"></gn-cmr-header>
  <div class="row">
      <div class="cadre cadre-left col-xs-12 col-sm-12 col-md-12 col-lg-6 col-xl-6" [style.min-height]="cardContentHeight + 'px'">
        <pnx-map height="100%" class="map-card">
          <pnx-gps (markerChanged)="setNewGeometry($event)"></pnx-gps>
          <pnx-leaflet-filelayer (onGeomChange)="onGeomChangeGPSFile($event)" [editMode]="true"></pnx-leaflet-filelayer>
          <pnx-leaflet-draw 
            [geojson]="geometry" 
            [options]="leafletDrawOptions" 
            [zoomLevel]="14"
            (layerDrawed)="setNewGeometry($event)">
          </pnx-leaflet-draw>
          <pnx-geojson
            *ngIf="mapFeatures && mapFeatures['features']"
            [geojson]="mapFeatures"
            [zoomOnLayer]="true"
            [zoomOnFirstTime]="true"
          ></pnx-geojson>
        </pnx-map>
      </div>
      <div class="cadre col-xs-12 col-sm-12 col-md-12 col-lg-6 col-xl-6 scroll">
        <div class="clearfix">
          <h4 class="float-left">{{ bEdit ? 'Edition' : 'Création'}} {{module.forms.site.label}} {{bEdit ? ': ' + site.name : ''}}</h4>
          <span class="float-right" *ngIf="!bEdit">
            <i class="fa fa-repeat fa-lg"></i>
            <mat-slide-toggle id="repeat" color="primary" [(ngModel)]="bChainInput" matTooltip="Enchainer les saisies"></mat-slide-toggle>
          </span>
        </div>
        <form [formGroup]="siteForm">
        <div class="alert alert-danger" role="alert" *ngIf="!siteForm.value.geom">
          <i class="fa fa-warning"></i>&nbsp;Veuillez saisir une géométrie sur la carte
        </div>
        <div class="alert alert-info" role="alert">
          <i class="fa fa-info-circle"></i>&nbsp;Seul les fichiers de Points aux formats .gpx, .geojson ou .kml peuvent être importés. <br><span class="ml-3"></span>Veuillez utiliser une projection en WGS84.
        </div>
        <pnx-dynamic-form-generator
          class="obj-form"
          #dynamicForm
          [autoGenerated]="true"
          [myFormGroup]="siteForm"
          [formsDefinition]="siteFormDefinitions"
        ></pnx-dynamic-form-generator>

        <gn-cmr-form-error [form]="siteForm"></gn-cmr-form-error>
        <div class="clearfix toolbar mt-3">
          <button class="btn btn-primary float-left" [routerLink]="['..']" *ngIf="!bEdit">Annuler</button>
          <button class="btn btn-primary float-left" [routerLink]="['..', 'site', site.id_site]" *ngIf="bEdit">Annuler</button>
          <button *ngIf="!bChainInput  && !bEdit" class="btn btn-success float-right" [disabled]="!siteForm.valid || bSaving" (click)="onSubmit(true)">
            <i class="fa fa-check" *ngIf="!bSaving"></i>
            <i class="fa fa-spinner fa-spin" *ngIf="bSaving"></i>&nbsp;Valider et ajouter {{module.forms.visit.label}}</button>
          <button *ngIf="!bChainInput" class="btn btn-success float-right mr-2" [disabled]="!siteForm.valid || bSaving" (click)="onSubmit(false)">
            <i class="fa fa-check" *ngIf="!bSaving"></i>
            <i class="fa fa-spinner fa-spin" *ngIf="bSaving"></i>&nbsp;Valider</button>
          <button *ngIf="bChainInput" class="btn btn-success float-right" [disabled]="!siteForm.valid || bSaving" (click)="onSubmit(false)">
            <i class="fa fa-check" *ngIf="!bSaving"></i>
            <i class="fa fa-spinner fa-spin" *ngIf="bSaving"></i>&nbsp;Valider et enchainer les saisies</button>
        </div>
      </form>
    </div> 
  </div>
</div>
